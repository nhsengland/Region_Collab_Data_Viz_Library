---
title: "NHS R Data Visualisation Library"
author: "NHS England Regional Collaboration utilising the foundations of a GGplot library created by Mike Perham"
date: "17/05/2024"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This library has been created to enable users to view examples of data visualisations utilising the NHS themes, using NHS public datasets. Users can load the required packages and create the sample datasets, and then choose which data visualisations they would like to run in their own environment.

The foundations of this library are sourced from a GGplot guide by Mike Perham. This has been expanded as a proof of concept for working collaboratively over regions to input and build upon, becoming the R Data Viz Library.

# Install/load required packages

```{r LoadData, warning = FALSE, message = FALSE}
if (!require("pacman")) install.packages("pacman"); library(pacman)

pacman::p_load(Rcpp, tidyverse,dplyr,tidyr,
               ggplot2,ggthemes,ggtext,scales, NHSRtheme,
               png,ggalt,NHSRdatasets)
```

## Load sample data

All of the examples in this document use dummy data from the NHSRdatasets package. The next step loads the data and performs some simple filtering steps.

```{r , warning = FALSE}
#Load initial dataset and clean up
Attends <- NHSRdatasets::ae_attendances %>%
  filter(org_code == "RXQ"|org_code=="RTH"|org_code=="RHW"|
           org_code == "RTK"|org_code == "RA2") %>%
  filter(type ==1) %>%
  select(-c(3,5))
```

# NHSR Theme

All of the examples in this document use dummy data from the NHSRdatasets package. The next step loads the data and performs some simple filtering steps.

```{r , warning = FALSE}
#install.packages("remotes")
#remotes::install_github("nhs-r-community/NHSRtheme")

NHSRtheme::get_nhs_colours()

```

# Data Over Time

## Basic line chart

```{r , warning = FALSE}
#Filter initial dataset
line_df <- Attends %>%
  filter(org_code=="RXQ")

#Make plot
ggplot(line_df, aes(x = period, y = attendances)) +
  geom_line(colour = "#005EB8", size = 1.5) +
  labs(title="Type 1 attendances - Bucks Healthcare",
       subtitle = "April 2016 to March 2019") +
  expand_limits(y = 0)
```

## Multiple line chart

```{r , warning = FALSE}
#Filter initial dataset
multiple_line_df <- Attends %>%
  filter(org_code == "RXQ" | org_code=="RTH") 

#Make plot
ggplot(multiple_line_df, aes(x = period, y = attendances, colour = org_code)) +
  geom_line(size = 1) +
  geom_point()+
  scale_colour_manual(values = c("#005EB8", "#41B6E6")) +
  labs(title="Type 1 attendances - Bucks Healthcare vs Royal Berkshire",
       subtitle = "April 2016 to March 2019") +
  expand_limits(y = 0)

```

# Comparisons

## Simple bar chart

```{r , warning = FALSE}
#Filter initial dataset
bar_df <- Attends %>%
  filter(period == "2019-03-01")

#Make plot
bar <- ggplot(bar_df, aes(x = org_code, y = attendances)) +
  geom_bar(stat="identity", 
           position="identity", 
           fill="#005EB8") +
  geom_hline(yintercept = 0, size = 1, colour="#333333") +
  labs(title="Type 1 attendances",
       subtitle = "March 2019")

plot(bar)

```

### Add labels

The code below adds labels to your simple bar chart.

```{r , warning = FALSE}
#Filter initial dataset
bar + geom_text(aes(label = attendances), vjust =2, color= "White")

```

## Grouped bar chart

```{r , warning = FALSE}
#Filter initial dataset
grouped_bar_df <- Attends %>%
  filter(period == "2017-03-01" | period == "2019-03-01") %>%
  select(c(1:3))

#Make plot
ggplot(grouped_bar_df, 
                aes(x = org_code, 
                y = attendances, 
                fill = as.factor(period))) +
  geom_bar(stat="identity", position="dodge") +
  geom_hline(yintercept = 0, size = 1, colour="#333333") +
  NHSRtheme::scale_fill_nhs('blues')+
  labs(title="Attendances have increase in all providers other than Bucks Healthcare",
       subtitle = "March 2017 vs March 2019")

```

## Bubble chart

Insert here

## Population Pyramid chart

Insert here

## Radar chart

Insert here

## Radial chart

Insert here

## Radial Column chart

Insert here

## Span chart

Insert here

## Stacked area chart

Insert here

## Stacked bar chart

Insert here

# Creating multiple charts for the same measure

## Faceted chart

Use `facet_wrap()` to create multiple charts split by subgroup in data. You can use `ncol =` or `nrow` to specify number of rows or columns. For example, `facet_wrap(~org_code, nrow=1)` to put all charts in a single row.

```{r , warning = FALSE}
ggplot(Attends, aes(x = period, y = attendances)) +
  geom_line(colour = "#005EB8", size = 1) +
  facet_wrap(~org_code)+
  labs(title="Type 1 attendances",
       subtitle = "April 2016 to March 2019") +
  expand_limits(y = 0)

```

# Range

## Box & Whisker chart

Insert here

## Bullet chart

Insert here

## Candlestick chart

Insert here

## Error bars chart

Insert here

## Gantt chart

Insert here

## Kagi chart

Insert here

## Span chart

Insert here

## Violin chart

Insert here

## Dumbell chart

The `ggtext` package can be used to add colour to titles or subtitles. You need to ensure that you use it with `theme(plot.subtitle = element_markdown(hjust = 0, size = 12))` otherwise it will not work.

```{r, warning = FALSE}
#Prepare data
dumbbell_df <- NHSRdatasets::ae_attendances %>%
  filter(type ==1) %>%
  select(-c(3,6)) %>%
  filter(period == "2017-03-01" | period =="2019-03-01") %>%
  mutate(period =as.numeric(format(period,'%Y'))) %>%
  mutate(period = as.character(period)) %>%
    mutate(performance = 1- (breaches/attendances)) %>%
  select(c(1:2,5)) %>%
  spread(period, performance) %>%
  mutate(gap = `2019` - `2017`) %>%
  arrange(desc(gap)) %>%
  head(10)

#Make plot
dumbell <- ggplot(dumbbell_df, aes(x = `2017`, xend = `2019`, y = reorder(org_code, gap), group = org_code)) + 
  geom_dumbbell(colour = "#dddddd",
                size = 3,
                colour_x = "#41B6E6",
                colour_xend = "#005EB8") +
  scale_x_continuous(labels = scales::percent_format(accuracy=1))+
  geom_vline(xintercept = 0.95, size = 1, colour="#333333", linetype = "dashed") +
  labs(title = "Performance improved for all providers",
    subtitle = "<span style='color: #41B6E6;'>March 2017 <span><span style='color: black;'> vs <span><span style='color: #005EB8;'>March 2019<span>") +
  xlab("4 hour performance") +
  ylab("Org code") +
 theme(plot.subtitle = element_markdown(hjust = 0, size = 12))+ theme(legend.position = "none")

plot(dumbell)
```

### Adding annotations

You can use `geom_label` to add annotations to existing plots or you can add line in when creating ggplot.

```{r, warning = FALSE}

dumbell + geom_label(aes(x = 0.9, y = "R1K",label = "Standard"), 
                           hjust = -0.5, 
                           vjust = -0.1, 
                           colour = "#555555",
                           label.size = NA, 
                           family="Arial", 
                           size = 4)

```
