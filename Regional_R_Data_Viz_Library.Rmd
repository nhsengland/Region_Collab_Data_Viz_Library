---
title: "NHS R Data Visualisation Library"
author: "NHS England Regional Collaboration utilising the foundations of a GGplot library created by Mike Perham"
date: "17/05/2024"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This library has been created to enable users to view examples of data visualisations utilising the NHS themes, using NHS public data sets. Users can load the required packages and create the sample data sets, and then choose which data visualisations they would like to run in their own environment.

The foundations of this library are sourced from a GGplot guide by Mike Perham. This has been expanded as a proof of concept for working collaboratively over regions to input and build upon, becoming the R Data Viz Library.

For more information about each data visualisation type, the below are recommended to review:

### The Data Visualisation Catalogue: <https://datavizcatalogue.com/index.html>

### The R Graph Gallery: <https://r-graph-gallery.com/>

### Top 50 GGplot2 Visualisations: <https://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html>

# Install/load required packages

```{r LoadData, warning = FALSE, message = FALSE}
if (!require("pacman")) install.packages("pacman"); library(pacman)

pacman::p_load(Rcpp, tidyverse,dplyr,tidyr,
               ggplot2,ggthemes,ggtext,scales,
               png,ggalt,NHSRdatasets,onsr,shinycssloaders, plotly, FunnelPlotR)


# install.packages('devtools')
#devtools::install_github('nhs-r-community/NHSRtheme')
# install.packages("remotes")
remotes::install_github("rOpenSci/fingertipsR",
                        build_vignettes = TRUE,
                        dependencies = "suggests",
                        build = F)
devtools::install_github("ricardo-bion/ggradar")
#https://github.com/ricardo-bion/ggradar
```

# Load sample data

All of the examples in this document use A&E dummy data from the NHSRdatasets package for NHS reporting, fingertips data for Public Health and ONS data for population data. These give us broad datasets that can be used for different data visualisation types.

More information on these packages can be found here:

### NHSRdatasets:

<https://github.com/nhs-r-community/NHSRdatasets>

<https://nhs-r-community.github.io/NHSRdatasets/>

```{r , warning = FALSE}
#Load initial dataset and clean up
Attends <- NHSRdatasets::ae_attendances %>%
  filter(org_code == "RXQ"|org_code=="RTH"|org_code=="RHW"|
           org_code == "RTK"|org_code == "RA2") %>%
  filter(type ==1) %>%
  select(-c(3,5))
```

### Fingertips:

<https://github.com/ropensci/fingertipsR>

The below gets population by sex.

```{r , warning = FALSE,eval=FALSE}

# Load fingertipsR package
library(fingertipsR)

# Get available profiles in fingertips
profiles_data <- profiles()
print(profiles_data)

# Find profiles related to population
population_profiles <- profiles_data %>%
  filter(grepl("population", ProfileName, ignore.case = TRUE))
print(population_profiles)

# Search for indicators related to population structure, DomainID was found by viewing the population_profiles and selecting a DomainID
population_indicators <- indicator_metadata(DomainID = "1938133081") #Replace with DomainID from above

# Get the relevant indicator of the measure from your list of population_indicators
indicator_id <- 92708  # Replace with the actual indicator ID from the results above

#Get list of area types
area_types_data <- area_types()

# Get the data for the specific indicator
population_data <- fingertips_data(IndicatorID = indicator_id,AreaTypeID = "15") #Note for Area Types you can select all, but it will take a long time. 15 is England.

# Filter data to include only relevant columns and non-NA values
population_data_filtered <- population_data %>%
  filter(!is.na(Age), !is.na(Value)) %>%
  select(AreaName, Sex, Age, Value)

# Adjust the values for plotting (male values negative for pyramid structure)
population_data_filtered <- population_data_filtered %>%
  mutate(Value = ifelse(Sex == "Male", -Value, Value)) %>%
  filter(Age != "All ages") %>%
  filter(Sex != "Persons")

# Convert the Age column to a factor and specify the levels in the desired order
population_data_filtered$Age <- factor(population_data_filtered$Age, levels = c("0-4 yrs", "5-9 yrs", "10-14 yrs", "15-19 yrs", "20-24 yrs", "25-29 yrs", "30-34 yrs", "35-39 yrs", "40-44 yrs", "45-49 yrs", "50-54 yrs", "55-59 yrs", "60-64 yrs", "65-69 yrs", "70-74 yrs", "75-79 yrs", "80-84 yrs", "85-89 yrs","90+ yrs"))
```

### ONS:

[https://medium.com/\@VickyCrockett1/how-do-you-get-data-into-r-from-the-ons-c860043fef8c](https://medium.com/@VickyCrockett1/how-do-you-get-data-into-r-from-the-ons-c860043fef8c){.uri}

The next step loads the data and performs some simple filtering steps.

# NHSR Theme

All of the examples in this document use dummy data from the NHSRdatasets package (more information on this package can be found here: <https://github.com/nhs-r-community/NHSRtheme>). As the package is not in CRAN, you need to use devtools to load the package from github.

```{r , warning = FALSE, echo = FALSE, warning = FALSE}

remotes::install_github("nhs-r-community/NHSRtheme")

NHSRtheme::get_nhs_colours()

```

# Data Over Time

## Basic line chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE}
#Filter initial dataset
line_df <- Attends %>%
  filter(org_code=="RXQ")

#Make plot
ggplot(line_df, aes(x = period, y = attendances)) +
  geom_line(colour = "#005EB8", size = 1.5) +
  scale_y_continuous(labels = comma) +
  labs(title="Type 1 attendances - Bucks Healthcare",
       subtitle = "April 2016 to March 2019",
       y = "Attendances",
       x = "Month") +
  expand_limits(y = 0)

```

### Plotly

NEY TO ADD IN

## Multiple line chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE}
#Filter initial dataset
multiple_line_df <- Attends %>%
  filter(org_code == "RXQ" | org_code=="RTH") 

#Make plot
ggplot(multiple_line_df,
         aes(x = period, y = attendances, colour = org_code)) +
  geom_line(size = 1) +
  geom_point() +
  scale_colour_manual(values = c("#005EB8", "#41B6E6")) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Type 1 attendances - Bucks Healthcare vs Royal Berkshire",
    subtitle = "April 2016 to March 2019",
    y = "Attendances",
    x = "Month"
  ) +
  expand_limits(y = 0) +
  theme(legend.title = element_blank())

```

### Plotly

NEY TO ADD IN

## SPC Charts

```{r, warning = FALSE}

```


# Comparisons

## Simple bar chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE}
#Filter initial dataset
bar_df <- Attends %>%
  filter(period == "2019-03-01")

#Make plot
bar <- ggplot(bar_df, aes(x = org_code, y = attendances)) +
  geom_bar(stat = "identity",
           position = "identity",
           fill = "#005EB8") +
  geom_hline(yintercept = 0,
             size = 1,
             colour = "#333333") +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Type 1 attendances",
    subtitle = "March 2019",
    y = "Attendances",
    x = "Provider Code"
  )

plot(bar)

```

**Add labels**

The code below adds labels to your simple bar chart.

```{r , warning = FALSE}
#Filter initial dataset
bar + geom_text(aes(label = scales::comma(attendances)), vjust =2, color= "White")

```

### Plotly
```{r , warning = FALSE}
#install all necessary packages

# Specify your packages
my_packages <- c("tidyverse", "plotly", "readxl") 

# Extract not installed packages
not_installed <- my_packages[!(my_packages %in% installed.packages()[ , "Package"])]    

# Install not installed packages
if(length(not_installed)) install.packages(not_installed)                               

# Load all packages
lapply(my_packages, library, character.only = TRUE)                                     

#-----------------------------------
#Perform any data manipulation needed

##Filter the data to select just the region
simple_bar_data <- Attends %>% filter(period == "2019-03-01")   

## Tell the x axis to keep the data in the same order not rearrange alphabetically (this is only needed if the x axis is a character not a date )
#xform <- list(categoryorder = "array", categoryarray = Attends$org_code) 

Attends$org_code <- as.character(Attends$org_code)

#--------------------------------
#Plot the Chart

##Set bar colours
simple_bar_blue <- plot_ly(simple_bar_data, x = ~org_code, y = ~attendances, type = "bar", colors = '#005EB8') %>%

##set titles and axis labels    
  layout(title = list(text = '<b>Type 1 attendances</b><br><sup>March 2019</sup>', x = 0, xanchor= 'left'),                           
         xaxis = list(title = "Provider Code"),
         yaxis = list(title = "Attendances"),
         legend = list() ) %>%
  
##remove any unnecessary functions of plotly chart
config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "select2d", "lasso2d", "toImage",   
                                    "pan2d", "autoScale2d", "resetScale2d", "zoom2d"))

simple_bar_blue

```

**Add labels**

The code below adds labels to your simple bar chart.

```{r , warning = FALSE}
#Plot the Chart

##Set bar colours
simple_bar_blue <- plot_ly(simple_bar_data, x = ~org_code, y = ~attendances, type = "bar", text = ~attendances, textposition = 'auto', marker = list(color = '#005EB8', line = list(colour ='#FFFFFF'), width = 1.5)) %>%

##set titles and axis labels    
  layout(title = list(text = '<b>Type 1 attendances</b><br><sup>March 2019</sup>', x = 0, xanchor= 'left'),                           
         xaxis = list(title = "Provider Code"),
         yaxis = list(title = "Attendances"),
         legend = list() ) %>%
  
##remove any unnecessary functions of plotly chart
config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "select2d", "lasso2d", "toImage",   
                                    "pan2d", "autoScale2d", "resetScale2d", "zoom2d"))

simple_bar_blue

```


## Grouped bar chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE}
#Filter initial dataset
grouped_bar_df <- Attends %>%
  filter(period == "2017-03-01" | period == "2019-03-01") %>%
  select(c(1:3))

#Make plot
ggplot(grouped_bar_df,
       aes(
         x = org_code,
         y = attendances,
         fill = as.factor(period)
       )) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = 0,
             size = 1,
             colour = "#333333") +
  scale_y_continuous(labels = comma) +
  #NHSRtheme::scale_fill_nhs('blues')+
  labs(
    title = "Attendances have increased in all providers other than Bucks Healthcare",
    subtitle = "March 2017 vs March 2019",
    y = "Attendances",
    x = "Provider Code"
  ) +
  theme(legend.title = element_blank())

```
### plotly

```{r , warning = FALSE}
### Plotly version
   
  grouped_bar_df_plotly <- Attends %>%
  filter(period == "2017-03-01" | period == "2019-03-01") %>%
  select(c(1:3))

grouped_bar_df_plotly$org_code <- as.character(grouped_bar_df_plotly$org_code)

grouped_bar_df_plotly <- pivot_wider(grouped_bar_df_plotly,names_from = period,values_from = attendances)

plot_ly(data = grouped_bar_df_plotly, 
        x = ~org_code, 
        y = ~`2017-03-01`,
        marker = list(color = '#003087'), 
        name = '2017-03-01',
        type = "bar")%>%
    add_trace(data = grouped_bar_df_plotly, 
        x = ~org_code, 
        y = ~`2019-03-01`,
        name = '2019-03-01',
        marker = list(color = '#0072CE'))%>%
  
    layout(title = 'Attendances have increased in all providers other than Bucks Healthcare',##set titles and axis labels  
      xaxis = list(title = "Provider code"),
      yaxis = list(title = "Attendances"),
      barmode = 'group')%>%

config(modeBarButtonsToRemove = c("zoomIn2d", "zoomOut2d", "select2d", "lasso2d", "toImage","pan2d", "autoScale2d", "resetScale2d", "zoom2d"))
```


## Stacked bar chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE, message = FALSE}
AttendsAll <- NHSRdatasets::ae_attendances %>%
  filter(
    org_code == "RXQ" | org_code == "RTH" | org_code == "RHW" |
      org_code == "RTK" | org_code == "RA2"
  ) %>%
  filter(period == '2017-03-01')

ggplot(AttendsAll, aes(fill = type, y = attendances, x = org_code)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_y_continuous(labels = comma) +
  labs(title = "A&E attendances by department type - March 2017",
       y = "Attendances",
       x = "Provider Code") +
  theme(legend.title = element_blank())

```

### Plotly

NEY TO ADD IN

## Percent stacked bar chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE}
AttendsAll <- NHSRdatasets::ae_attendances %>%
  filter(
    org_code == "RXQ" | org_code == "RTH" | org_code == "RHW" |
      org_code == "RTK" | org_code == "RA2"
  ) %>%
  filter(period == '2017-03-01')

ggplot(AttendsAll, aes(fill = type, y = attendances, x = org_code)) +
  geom_bar(position = "fill", stat = "identity") +
  scale_y_continuous(labels = percent) +
  labs(title = "A&E attendances by department type - March 2017",
       y = "Attendances",
       x = "Provider Code") +
  theme(legend.title = element_blank())

```

### Plotly

NEY TO ADD IN

## Bubble chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE}

#For this example we are filtering on 5 organisations, type 1 activity & excluding column 3 from the dataframe.
Attends <- NHSRdatasets::ae_attendances %>%
  filter(org_code == "RXQ"|org_code=="RTH"|org_code=="RHW"|
           org_code == "RTK"|org_code == "RA2")

  # Summarise data for type 1 attendances
  type_1_summary <- Attends %>%
  filter(type == 1) %>%
  group_by(org_code, period) %>%
  summarise(type_1_attendances = sum(attendances, na.rm = TRUE)) %>%
  ungroup()

# Summarise data for non-type 1 attendances
type_other_summary <- Attends %>%
  filter(type == 3|type== 2) %>%
  group_by(org_code, period) %>%
  summarise(type_other_attendances = sum(attendances, na.rm = TRUE)) %>%
  ungroup()

# Summarise total attendances and total admissions
total_summary <- Attends %>%
  group_by(org_code, period) %>%
  summarise(
    total_attendances = sum(attendances, na.rm = TRUE),
    total_breaches = sum(breaches, na.rm = TRUE),
    total_admissions = sum(admissions, na.rm = TRUE)
  ) %>%
  ungroup()

# Merge the summaries into a single data frame
final_summary <- total_summary %>%
  left_join(type_1_summary, by = c("org_code", "period")) %>%
  left_join(type_other_summary, by = c("org_code", "period"))

# Replace NA values with 0 for type_1_attendances and type_3_attendances
final_summary <- final_summary %>%
  mutate(
    type_1_attendances = replace_na(type_1_attendances, 0),
    type_other_attendances = replace_na(type_other_attendances, 0)
  )

# Add percentage columns
final_summary <- final_summary %>%
  mutate(
    perc_admissions_attendances = (total_admissions / total_attendances) * 100,
    perc_type1_attendances_total = (type_1_attendances / total_attendances) * 100,
    perc_breaches_attendances = (total_breaches / total_attendances) * 100
  )

# Filter initial dataset
bubble_df <- final_summary

# Calculate size for bubble chart (proportional to type 1 attendances)
bubble_df <- bubble_df %>%
  mutate(size = perc_type1_attendances_total / max(perc_type1_attendances_total) * 100)

# Create bubble chart
ggplot(bubble_df, aes(x = perc_admissions_attendances, y = perc_breaches_attendances, size = size, color = size)) +
  geom_point(alpha = 0.5) +
  scale_size_continuous(name = "Proportion of type 1") +
  #NHSRtheme::scale_fill_nhs('blues', name = "Proportion of type 1") +
  labs(title = "Bubble Chart of % 4 Hour Breaches vs % converted to admission with % Attendances Type 1 Size",
       x = "Conversion Rate", y = "% 4 Hour Breaches") +
  theme(legend.position = "right")
```

### Plotly

```{r, warning = FALSE}

#For this example we are filtering on 5 organisations, type 1 activity & excluding column 3 from the dataframe.
Attends <- NHSRdatasets::ae_attendances %>%
  filter(org_code == "RXQ"|org_code=="RTH"|org_code=="RHW"|
           org_code == "RTK"|org_code == "RA2")

# Summarise data for type 1 attendances
  type_1_summary <- Attends %>%
  filter(type == 1) %>%
  group_by(org_code, period) %>%
  summarise(type_1_attendances = sum(attendances, na.rm = TRUE)) %>%
  ungroup()

# Summarise data for non-type 1 attendances
type_other_summary <- Attends %>%
  filter(type == 3|type== 2) %>%
  group_by(org_code, period) %>%
  summarise(type_other_attendances = sum(attendances, na.rm = TRUE)) %>%
  ungroup()

# Summarise total attendances and total admissions
total_summary <- Attends %>%
  group_by(org_code, period) %>%
  summarise(
    total_attendances = sum(attendances, na.rm = TRUE),
    total_breaches = sum(breaches, na.rm = TRUE),
    total_admissions = sum(admissions, na.rm = TRUE)
  ) %>%
  ungroup()

# Merge the summaries into a single data frame
final_summary <- total_summary %>%
  left_join(type_1_summary, by = c("org_code", "period")) %>%
  left_join(type_other_summary, by = c("org_code", "period"))

# Replace NA values with 0 for type_1_attendances and type_3_attendances
final_summary <- final_summary %>%
  mutate(
    type_1_attendances = replace_na(type_1_attendances, 0),
    type_other_attendances = replace_na(type_other_attendances, 0)
  )

# Add percentage columns
final_summary <- final_summary %>%
  mutate(
    perc_admissions_attendances = (total_admissions / total_attendances) * 100,
    perc_type1_attendances_total = (type_1_attendances / total_attendances) * 100,
    perc_breaches_attendances = (total_breaches / total_attendances) * 100
  )

# Filter initial dataset
bubble_df <- final_summary

# Calculate size for bubble chart (proportional to type 1 attendances)
bubble_df <- bubble_df %>%
  mutate(size = perc_type1_attendances_total / max(perc_type1_attendances_total) * 100)


# Create bubble chart
plot_ly(bubble_df, x = ~perc_admissions_attendances, y = ~perc_breaches_attendances, text = "Proportion of type 1", type = 'scatter', mode = 'markers', color = ~size, colors = 'Blues', size = ~size, sizes = c(5,20),
        marker = list(sizemode = 'diameter', opacity = 0.7)) %>% 
  layout(title = 'Bubble Chart of % 4 Hour Breaches vs \n % converted to admission with % Attendances Type 1 Size',
         xaxis = list(showgrid = FALSE, title = "Conversion Rate"),
         yaxis = list(showgrid = FALSE, title = "% 4 Hour Breaches"))

```


## Population Pyramid chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE, eval = FALSE}
# Plot the population pyramid
ggplot(population_data_filtered, aes(x = Age, y = Value, fill = Sex)) +
  geom_bar(stat = "identity", position = "identity") +
  coord_flip() +
  scale_y_continuous(labels = function(x) comma(abs(x))) +
  labs(title = "Population Age Profile by Gender",
       x = "Age Group",
       y = "Population Count",
       fill = "Gender") +
  NHSRtheme::scale_fill_nhs("blues")
```

### Plotly

NEY TO ADD IN

## Radar chart

```{r , warning = FALSE, eval=FALSE}
# Create Example dataset
data <- tibble::tribble(
  ~group, ~Trauma_and_Orthopaedics, ~General_Surgery, ~Gynaecology, ~Ophthalmology, ~Dermatology,
  "Trust 1", 0.8, 0.9, 0.7, 0.6, 0.9,
  "Trust 2", 0.6, 0.7, 0.8, 0.7, 0.6,
  "Trust 3", 0.7, 0.8, 0.9, 0.8, 0.7
)

# Create the radar chart
ggradar(data, 
        values.radar = c("0%", "50%", "100%"), #Sets labels for min, min & max grid lines
        grid.min = 0, grid.mid = 0.5, grid.max = 1, #Defines the values for the grid lines
        group.line.width = 2, #Changes the line width of plotted line
        group.point.size = 3, #Changes the point size of plotted line
        group.colours = c("#00AFBB", "#E7B800", "#FC4E07"), #Colour for plotted lines based on group
        background.circle.colour = "white", #Plot background colour
        gridline.mid.colour = "grey", #Colour of gridlines
        legend.position = "bottom") #Position can be 
```

## Radial Column chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE}

# Create a radial column chart
ggplot(Attends, aes(x = reorder(org_code, -attendances), y = attendances)) +
  geom_col(width = 0.5, fill = "skyblue") +
  coord_polar(start = 0) +
   #NHSRtheme::scale_fill_nhs("blues") +
  scale_y_continuous(labels = function(x) comma(abs(x))) +
  labs(title = "Attendances per Trust",
       x = NULL, y = NULL)
```

### Plotly

NEY TO ADD IN

## Span chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE}
# Summarize the data
summary_data <- Attends %>%
  group_by(org_code) %>%
  summarise(min_attendance = min(attendances),
            max_attendance = max(attendances))

# Create the horizontal bar range chart
ggplot(summary_data, aes(y = org_code)) +
  geom_linerange(aes(xmin = min_attendance, xmax = max_attendance), color = "blue", size = 1.5) +
  labs(title = "Range of Type 1 Attendances by Trust between 2019 and 2023",
       x = "Number of Attendances",
       y = "Organisation Code") +
   NHSRtheme::scale_fill_nhs("blues")
```

### Plotly

NEY TO ADD IN

## Stacked area chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE}

# Plot the stacked area chart
ggplot(Attends, aes(x = period, fill = org_code)) +
  geom_area(stat = "count") +
  NHSRtheme::scale_fill_nhs("blues")
```

### Plotly

NEY TO ADD IN

# Creating multiple charts for the same measure

## Faceted chart

Use `facet_wrap()` to create multiple charts split by subgroup in data. You can use `ncol =` or `nrow` to specify number of rows or columns. For example, `facet_wrap(~org_code, nrow=1)` to put all charts in a single row.

```{r , warning = FALSE}
ggplot(Attends, aes(x = period, y = attendances)) +
  geom_line(colour = "#005EB8", size = 1) +
  facet_wrap(~org_code)+
  labs(title="Type 1 attendances",
       subtitle = "April 2016 to March 2019") +
  expand_limits(y = 0)

```

# Range

## Box & Whisker chart

```{r , warning = FALSE}
g <- ggplot(Attends, aes(org_code, attendances))
g + geom_boxplot(varwidth=T, fill="light blue") + 
    labs(title="A&E Attendances", 
         subtitle="Distribution by Trust",
         caption="Source: A&E Monthly Stats",
         x="Trust",
         y="A&E attendances")
```

## Bullet chart

```{r , warning = FALSE}

#Create a sample dataset - replace with your own
name = c("Trust A","Trust B","Trust C","Trust D","Trust E","Trust F","Trust G","Trust H","Trust I","Trust J")
count= c(89,85,76,64,50,45,29,20,10,5)

#Create a dataframe using sample data. Convert name to factor.
data = data.frame(name, count, stringsAsFactors = TRUE)

#Sets the coloured background
bullet_base <- data.frame(rank = c("Poor", "Ok", "Good", "Excellent"),
                          value = c(25, 25, 25, 25))
bullet_base_rep <- 
  do.call("rbind", replicate(nrow(data), bullet_base, simplify = FALSE)) %>%
  mutate(name = sort(rep(data$name, 4) ))

#head(bullet_base_rep, 10)

#Colour the background bars
bullet_colors <- c("#e44727", "#e4a727", "#61AB40", "#318100")
names(bullet_colors) <- c("Poor", "Ok", "Good", "Excellent")

#Create plot
ggplot() +
  geom_bar(data = bullet_base_rep, 
           aes(x = name, y = value, fill = rank), stat = "identity",
           position = "stack") +
  geom_bar(data = data, 
           aes(x = name, y = count), fill = "black", width = .2,
           stat = "identity") +
  scale_fill_manual(values = bullet_colors) +
  coord_flip(expand = FALSE)
```

## Funnel Plot

```{r , warning = FALSE}

MyAttends <- NHSRdatasets::ae_attendances %>%
  filter(period == '2017-03-01') %>%
  filter(type ==1) # %>%
  # select(-c(3,5)) 

MyAttends$org_code <- as.character(MyAttends$org_code)

funnel_plot(.data = MyAttends,
            numerator= breaches, #Specify the numerator
            denominator=attendances, #Specify the denominator
            group = org_code, #Specify that we want to plot Trust Names
            title = "A&E breaches", #Specify the chart title
            draw_adjusted = TRUE, #Specify that we want to adjust the control limits to account for over-dispersion
            sr_method = "SHMI", #Specify to adjust for over-dispersion using the CQC Methodology (can also use SHMI)
            # label = "highlight", #Specify that we want to use the 'highlight' argument to show outliers 
            # highlight=HighLight, #Get the highlight argument to reference the list of outlier NEY trusts 
            data_type="PR", #Specify the indicator is a proportion
            limit=95, #Specify to show both 95 and 99.8% control limits 
            multiplier = 100, 
            y_label = "% breaches", #Specify the X Axis Label
            x_label = "No. of attendances") #Specify the Y Axis Label

```       


## Gantt chart {.tabset .tabset-fade}

### ggplot

```{r , warning = FALSE}

# Load the dataset
df <- read.csv("https://cdn.rawgit.com/plotly/datasets/master/GanttChart-updated.csv", 
               stringsAsFactors = FALSE)

# Define the start date of each task & convert to date
df$Start <- as.Date(df$Start, format = "%m/%d/%Y")
# Define the end of the task by adding the duration to the start date
df$End <- df$Start + df$Duration

# Prepare the data for plotting
gantt_data <- df %>%
  mutate(task_id = row_number()) %>%
  select(task_id, Task, Start, End, Resource)

# Create the Gantt chart using ggplot2
gantt_chart <- ggplot(gantt_data, aes(x = Start, xend = End, y = reorder(Task, -task_id), yend = reorder(Task, -task_id), color = factor(Resource))) +
  geom_segment(size = 5) +
  labs(title = "Gantt Chart with NHS Blue Shades",
       x = "Date",
       y = "Task") +
  NHSRtheme::theme_nhs() +
  scale_color_manual(values = colorRampPalette(c("#005EB8", "#73C2FB"))(length(unique(gantt_data$Resource))))

# Print the Gantt chart
print(gantt_chart)
```

## Violin chart {.tabset .tabset-fade}

### ggplot

```{r, warning = FALSE}

#Violin Plot
ggplot(Attends, aes(org_code, attendances)) + geom_violin() + 
  labs(title="A&E Attendances", subtitle="Range by Trust", caption="Source: A&E Monthly Statistics", x="Trust", y="Attendances") + scale_fill_brewer(palette="Blues") + theme_classic()
```

## Dumbell chart {.tabset .tabset-fade}

### ggplot

The `ggtext` package can be used to add colour to titles or subtitles. You need to ensure that you use it with `theme(plot.subtitle = element_markdown(hjust = 0, size = 12))` otherwise it will not work.

```{r, warning = FALSE}
#Prepare data
dumbbell_df <- NHSRdatasets::ae_attendances %>%
  filter(type ==1) %>%
  select(-c(3,6)) %>%
  filter(period == "2017-03-01" | period =="2019-03-01") %>%
  mutate(period =as.numeric(format(period,'%Y'))) %>%
  mutate(period = as.character(period)) %>%
    mutate(performance = 1- (breaches/attendances)) %>%
  select(c(1:2,5)) %>%
  spread(period, performance) %>%
  mutate(gap = `2019` - `2017`) %>%
  arrange(desc(gap)) %>%
  head(10)

#Make plot
dumbell <- ggplot(dumbbell_df, aes(x = `2017`, xend = `2019`, y = reorder(org_code, gap), group = org_code)) + 
  geom_dumbbell(colour = "#dddddd",
                size = 3,
                colour_x = "#41B6E6",
                colour_xend = "#005EB8") +
  scale_x_continuous(labels = scales::percent_format(accuracy=1))+
  geom_vline(xintercept = 0.95, size = 1, colour="#333333", linetype = "dashed") +
  labs(title = "Performance improved for all providers",
    subtitle = "<span style='color: #41B6E6;'>March 2017 <span><span style='color: black;'> vs <span><span style='color: #005EB8;'>March 2019<span>") +
  xlab("4 hour performance") +
  ylab("Org code") +
 theme(plot.subtitle = element_markdown(hjust = 0, size = 12))+ theme(legend.position = "none")

plot(dumbell)
```

**Adding annotations**

You can use `geom_label` to add annotations to existing plots or you can add line in when creating ggplot.

```{r, warning = FALSE}

dumbell + geom_label(aes(x = 0.9, y = "R1K",label = "Standard"), 
                           hjust = -0.5, 
                           vjust = -0.1, 
                           colour = "#555555",
                           label.size = NA, 
                           family="Arial", 
                           size = 4)

```

### Plotly

NEY TO ADD IN

# Movement or Flow

## Sankey Diagram

NEY TO ADD IN
